<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cookie Clicker Calculator</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .emoji {
            font-size: 1.5em;
        }

        .mode-selector {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .mode-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            transform: scale(1.05);
        }

        .mode-btn:not(.active) {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .mode-btn:hover {
            transform: scale(1.08);
        }

        .content {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .upgrades-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .upgrades-table th,
        .upgrades-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .upgrades-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        .upgrades-table tr.best-upgrade {
            background: rgba(255, 215, 0, 0.2);
            font-weight: bold;
        }

        .purchase-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .purchase-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .simulation-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
        }

        .simulation-controls input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            font-size: 1em;
            width: 200px;
        }

        .run-btn {
            padding: 10px 30px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .run-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }

        .charts-container {
            margin-top: 30px;
        }

        .chart {
            margin-bottom: 30px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.5em;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
        }

        .history-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .toast.success {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }

        .toast.error {
            background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        }

        .toast.info {
            background: linear-gradient(135deg, #2196f3 0%, #03a9f4 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><span class="emoji">üç™</span> Cookie Clicker Calculator <span class="emoji">üç™</span></h1>
            <p>Optimize your cookie production with data-driven insights!</p>
        </header>

        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('interactive')">
                üìä Interactive Mode
            </button>
            <button class="mode-btn" onclick="switchMode('simulation')">
                ü§ñ Automatic Simulation
            </button>
        </div>

        <!-- Interactive Mode -->
        <div id="interactive-mode" class="content">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="current-cps">0</div>
                    <div class="stat-label">Cookies per Second</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="best-upgrade-name">-</div>
                    <div class="stat-label">Best Upgrade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="best-upgrade-time">-</div>
                    <div class="stat-label">Time to Reach</div>
                </div>
            </div>

            <table class="upgrades-table">
                <thead>
                    <tr>
                        <th>Upgrade</th>
                        <th>Level</th>
                        <th>Price</th>
                        <th>CPS</th>
                        <th>Efficiency</th>
                        <th>Time</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="upgrades-tbody">
                </tbody>
            </table>

            <div class="charts-container">
                <div class="chart" id="current-chart"></div>
            </div>

            <div class="export-buttons">
                <button class="export-btn" onclick="exportData('csv')">üìÑ Export CSV</button>
                <button class="export-btn" onclick="exportData('json')">üìã Export JSON</button>
                <button class="export-btn" onclick="refreshChart()">üîÑ Refresh Chart</button>
                <button class="export-btn" onclick="createBackup()">üóÑÔ∏è Backup DB</button>
                <button class="export-btn" onclick="onResetConfirm()" style="background:rgba(255,80,80,0.12);">‚ö†Ô∏è Reset to 0</button>
            </div>
        </div>

        <!-- Simulation Mode -->
        <div id="simulation-mode" class="content hidden">
            <div class="simulation-controls">
                <label>Number of purchases:</label>
                <input type="number" id="purchase-count" value="100" min="1" max="10000">
                <button class="run-btn" onclick="runSimulation()">‚ñ∂Ô∏è Run Simulation</button>
            </div>

            <div id="simulation-progress" class="hidden">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill">0%</div>
                </div>
            </div>

            <div id="simulation-results" class="hidden">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="sim-purchases">0</div>
                        <div class="stat-label">Total Purchases</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sim-cps">0</div>
                        <div class="stat-label">Final CPS</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sim-time">0</div>
                        <div class="stat-label">Total Time</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sim-cookies">0</div>
                        <div class="stat-label">Total Cookies</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart" id="sim-chart1"></div>
                    <div class="chart" id="sim-chart2"></div>
                    <div class="chart" id="sim-chart3"></div>
                    <div class="chart" id="sim-chart4"></div>
                </div>

                <div class="export-buttons">
                    <button class="export-btn" onclick="exportSimulation()">üíæ Download Results</button>
                </div>
            </div>

            <div class="history-section">
                <h2>üìú Simulation History</h2>
                <div id="simulation-history"></div>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'interactive';
        let currentSimulationData = null;
        let refreshTimeout = null;

        // Show toast notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Debounce function for performance
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function switchMode(mode) {
            currentMode = mode;
            
            // Update buttons
            document.querySelectorAll('.mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Show/hide content
            if (mode === 'interactive') {
                document.getElementById('interactive-mode').classList.remove('hidden');
                document.getElementById('simulation-mode').classList.add('hidden');
                loadUpgrades();
            } else {
                document.getElementById('interactive-mode').classList.add('hidden');
                document.getElementById('simulation-mode').classList.remove('hidden');
                loadSimulationHistory();
            }
        }

        function formatNumber(num, decimals = null) {
            if (num === null || num === undefined || isNaN(Number(num))) return '-';
            const n = Number(num);
            let fixed;
            if (decimals !== null) {
                fixed = n.toFixed(decimals);
            } else {
                // preserve integer if whole number, otherwise keep up to 1 decimal
                fixed = (Math.floor(n) === n) ? n.toString() : n.toFixed(1);
            }

            const parts = fixed.split('.');
            let intPart = parts[0];
            const fracPart = parts[1] || '';

            // thousands separator as dot (keeps previous look), decimal separator as comma
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");

            // Trim trailing zeros from fractional part
            let trimmedFrac = fracPart.replace(/0+$/g, '');

            return trimmedFrac ? `${intPart},${trimmedFrac}` : intPart;
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            return `${hours}h ${mins}m`;
        }

        async function loadUpgrades() {
            try {
                const response = await fetch('/api/upgrades');
                const data = await response.json();

                // Update stats (keep decimals for CPS, show 2 decimals)
                document.getElementById('current-cps').textContent = formatNumber(data.total_cps, 1);
                
                if (data.best_upgrade) {
                    document.getElementById('best-upgrade-name').textContent = data.best_upgrade.name;
                    document.getElementById('best-upgrade-time').textContent = formatTime(data.best_upgrade.time);
                } else {
                    document.getElementById('best-upgrade-name').textContent = '-';
                    document.getElementById('best-upgrade-time').textContent = '-';
                }

                // Update table
                const tbody = document.getElementById('upgrades-tbody');
                tbody.innerHTML = '';

                data.upgrades.forEach(upgrade => {
                    const row = document.createElement('tr');
                    if (upgrade.is_best) {
                        row.classList.add('best-upgrade');
                    }

                    row.innerHTML = `
                        <td>${upgrade.name}${upgrade.is_best ? ' ‚≠ê' : ''}</td>
                        <td>${upgrade.level}</td>
                        <td>${formatNumber(upgrade.current_price)}</td>
                        <td>${formatNumber(upgrade.cps, 1)}</td>
                        <td>${upgrade.value ? upgrade.value.toExponential(2) : '-'}</td>
                        <td>${upgrade.time_to_reach ? formatTime(upgrade.time_to_reach) : '-'}</td>
                        <td>
                            <button class="purchase-btn" onclick="purchaseUpgrade('${upgrade.name}')">Buy</button>
                            <button class="purchase-btn" style="margin-left:8px;background:linear-gradient(135deg,#ff7675 0%,#ff4757 100%);" onclick="decreaseUpgrade('${upgrade.name}')">Downgrade</button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });

                // Refresh chart
                refreshChart();

            } catch (error) {
                console.error('Error loading upgrades:', error);
                showToast('‚ùå Failed to load upgrades', 'error');
            }
        }

        async function purchaseUpgrade(name) {
            try {
                const response = await fetch(`/api/upgrade/${name}`, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showToast(`‚úÖ ${name} purchased! (Lvl ${data.upgrade.level})`, 'success');
                    loadUpgrades();
                } else {
                    showToast('‚ùå ' + (data.error || 'Purchase failed'), 'error');
                }
            } catch (error) {
                console.error('Error purchasing upgrade:', error);
                showToast('‚ùå Purchase failed', 'error');
            }
        }

        async function decreaseUpgrade(name) {
            try {
                const response = await fetch(`/api/upgrade/${name}/decrease`, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    showToast(`‚Ü©Ô∏è ${name} downgraded. (Lvl ${data.upgrade.level})`, 'info');
                    loadUpgrades();
                } else {
                    showToast('‚ùå ' + (data.error || 'Downgrade failed'), 'error');
                }
            } catch (error) {
                console.error('Error downgrading upgrade:', error);
                showToast('‚ùå Downgrade failed', 'error');
            }
        }

        async function refreshChart() {
            try {
                const response = await fetch('/api/charts/current');
                const chartJson = await response.json();
                const chartData = JSON.parse(chartJson);

                Plotly.newPlot('current-chart', chartData.data, chartData.layout);
            } catch (error) {
                console.error('Error loading chart:', error);
            }
        }

        async function runSimulation() {
            const purchases = parseInt(document.getElementById('purchase-count').value);
            
            // Validation
            if (isNaN(purchases) || purchases < 1 || purchases > 10000) {
                showToast('‚ö†Ô∏è Please enter a valid number between 1 and 10000', 'error');
                return;
            }

            showToast('üöÄ Starting simulation...', 'info');

            // Show progress
            document.getElementById('simulation-progress').classList.remove('hidden');
            document.getElementById('simulation-results').classList.add('hidden');
            document.getElementById('progress-fill').style.width = '0%';
            document.getElementById('progress-fill').textContent = '0%';

            try {
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    if (progress >= 95) {
                        clearInterval(progressInterval);
                    }
                    document.getElementById('progress-fill').style.width = progress + '%';
                    document.getElementById('progress-fill').textContent = progress + '%';
                }, 100);

                const response = await fetch('/api/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ purchases })
                });

                const data = await response.json();
                
                clearInterval(progressInterval);
                
                if (!data.success && data.error) {
                    throw new Error(data.error);
                }
                
                currentSimulationData = data;

                document.getElementById('progress-fill').style.width = '100%';
                document.getElementById('progress-fill').textContent = '100%';

                setTimeout(() => {
                    document.getElementById('simulation-progress').classList.add('hidden');
                    displaySimulationResults(data);
                    loadSimulationHistory();
                    showToast('‚úÖ Simulation completed!', 'success');
                }, 500);

            } catch (error) {
                console.error('Error running simulation:', error);
                document.getElementById('simulation-progress').classList.add('hidden');
                showToast('‚ùå Simulation failed: ' + error.message, 'error');
            }
        }

        async function displaySimulationResults(data) {
            document.getElementById('simulation-results').classList.remove('hidden');

            // Update stats
            document.getElementById('sim-purchases').textContent = formatNumber(data.total_purchases);
            document.getElementById('sim-cps').textContent = formatNumber(data.final_cps, 1);
            document.getElementById('sim-time').textContent = formatTime(data.total_time);
            document.getElementById('sim-cookies').textContent = formatNumber(data.total_cookies);

            // Load charts
            try {
                const response = await fetch('/api/simulation-charts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const charts = await response.json();

                const chart1 = JSON.parse(charts.chart1);
                Plotly.newPlot('sim-chart1', chart1.data, chart1.layout);

                const chart2 = JSON.parse(charts.chart2);
                Plotly.newPlot('sim-chart2', chart2.data, chart2.layout);

                if (charts.chart3) {
                    const chart3 = JSON.parse(charts.chart3);
                    Plotly.newPlot('sim-chart3', chart3.data, chart3.layout);
                }

                const chart4 = JSON.parse(charts.chart4);
                Plotly.newPlot('sim-chart4', chart4.data, chart4.layout);

            } catch (error) {
                console.error('Error loading simulation charts:', error);
            }

            loadSimulationHistory();
        }

        async function exportData(format) {
            showToast(`üì• Downloading ${format.toUpperCase()} export...`, 'info');
            window.location.href = `/api/export/${format}`;
        }

        function exportSimulation() {
            if (!currentSimulationData) {
                showToast('‚ö†Ô∏è No simulation data to export', 'error');
                return;
            }

            const dataStr = JSON.stringify(currentSimulationData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `simulation_${currentSimulationData.timestamp}.json`;
            link.click();
            showToast('‚úÖ Simulation exported!', 'success');
        }

        function onResetConfirm() {
            if (!confirm('This will set ALL upgrade levels to 0. This action is irreversible. Continue?')) {
                return;
            }
            resetUpgrades();
        }

        async function resetUpgrades() {
            try {
                // Create backup before reset
                const bresp = await fetch('/api/backup', { method: 'POST' });
                const bdata = await bresp.json();
                if (!bdata.success) {
                    showToast('‚ùå Could not create backup before reset', 'error');
                    return;
                }
                showToast('üì¶ Backup created: ' + bdata.filename, 'info');

                // Now perform reset
                const response = await fetch('/api/reset', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast('‚úÖ All upgrades reset to 0 (backup: ' + (data.backup || bdata.filename) + ')', 'success');
                    loadUpgrades();
                } else {
                    showToast('‚ùå Reset failed: ' + (data.error || ''), 'error');
                }
            } catch (error) {
                console.error('Reset error:', error);
                showToast('‚ùå Reset failed', 'error');
            }
        }

        async function createBackup() {
            try {
                const response = await fetch('/api/backup', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showToast('üì¶ Backup created: ' + data.filename, 'success');
                    // Trigger download
                    const link = document.createElement('a');
                    link.href = data.url;
                    link.download = data.filename;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                } else {
                    showToast('‚ùå Backup failed: ' + (data.error || ''), 'error');
                }
            } catch (error) {
                console.error('Backup error:', error);
                showToast('‚ùå Backup failed', 'error');
            }
        }

        async function loadSimulationHistory() {
            try {
                const response = await fetch('/api/simulations');
                const simulations = await response.json();

                const historyDiv = document.getElementById('simulation-history');
                historyDiv.innerHTML = '';

                if (simulations.length === 0) {
                    historyDiv.innerHTML = '<p>No simulations yet. Run your first simulation!</p>';
                    return;
                }

                simulations.forEach(sim => {
                    const item = document.createElement('div');
                    item.classList.add('history-item');
                    item.innerHTML = `
                        <div>
                            <strong>${sim.timestamp}</strong><br>
                            Purchases: ${formatNumber(sim.total_purchases)} | 
                            Final CPS: ${formatNumber(Math.floor(sim.final_cps))}
                        </div>
                        <button class="export-btn" onclick="window.location.href='/simulations/${sim.filename}'">
                            üì• Download
                        </button>
                    `;
                    historyDiv.appendChild(item);
                });

            } catch (error) {
                console.error('Error loading simulation history:', error);
            }
        }

        // Initial load
        loadUpgrades();
    </script>
</body>
</html>
